#include "FreeRTOS.h"
#include <cstdint>
#include <vector>
#include "PcrTask.h"
#include "HostMessages.h"
#include "Pid.h"
#include "ThermalDriver.h"
#include "OpticsDriver.h"
#include "gio.h"


///////////////////////////////////////////////////////////////////////////////
PcrTask*        PcrTask::_pPcrTask = nullptr;         //Singleton.

///////////////////////////////////////////////////////////////////////////////
PcrTask* PcrTask::GetInstance()
{
    if (_pPcrTask == nullptr)
        _pPcrTask = new PcrTask;

    return _pPcrTask;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
extern "C" void StartPcrTask(void * pvParameters);
void StartPcrTask(void * pvParameters)
{
    PcrTask* pPcrTask = PcrTask::GetInstance();
    pPcrTask->ExecuteThread();
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
PcrTask::PcrTask()
{
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
PcrTask::~PcrTask()
{
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void    PcrTask::ExecuteThread()
{
    TickType_t    nPrevWakeTime = xTaskGetTickCount();
    
    while (true)
    {
        //Wait for PID delta time.
        vTaskDelayUntil (&nPrevWakeTime, (TickType_t)Site::kPidTick_ms / portTICK_PERIOD_MS);
        _site.Execute();
    }
}
    
///////////////////////////////////////////////////////////////////////////////
void    PcrTask::GetSysStatus(SysStatus* pSysStatus)
{
    //Copy the site's SiteStatus object to the SysStatus's SiteStatus object.
    _site.GetSiteStatus(pSysStatus->GetSiteStatusPtr());
}
